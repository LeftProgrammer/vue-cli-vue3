
## 案卷管理：Excel 导入 / 导出需求说明（前后端）

### 1. 背景与目标
在“案卷管理”页面增加 Excel 模板下载、数据导入、数据导出能力。

目标：
1. 提供固定模板，用户按模板维护数据。
2. 导入：将模板中的案卷数据批量写入数据库，导入成功后刷新列表。
3. 导出：按查询条件导出案卷数据为 Excel 文件（字段与模板一致）。

### 2. 术语与范围
1. **档案项目（父级）**：案卷所属的档案项目记录（上级页面/上级节点）。
2. **案卷（本级）**：本页面列表中的数据项。
3. 本需求覆盖：
   1) 案卷 Excel 模板下载
   2) 案卷 Excel 导入（写库）
   3) 案卷 Excel 导出（读库 -> 生成 Excel）

### 3. 前端页面与入口
页面地址：
`E:\Project\XiongAn\vue\src\views\archives\archive_volume\index.vue`

前置条件（重要）：
1. 页面左侧为“档案项目”树。
2. **必须选中左侧树的档案项目节点，获得 `projectId` 后，才能进行导入/导出。**
3. 未选中节点（`projectId` 为空）时：
   1) “导入/导出”按钮置灰不可点击（推荐）。
   2) 如仍允许点击，则需提示：`请先选择档案项目`。

页面需新增功能按钮：
1. **模板下载**
2. **导入**
3. **导出**

### 4. 模板下载
模板文件路径：
`E:\Project\XiongAn\vue\public\static\template\案卷管理导入模板.xls`

交互说明：
1. 点击“模板下载”直接下载该文件。
2. 下载文件名：`案卷管理导入模板.xls`。

说明：
1. `public/` 目录下资源构建后应以站点根路径访问，通常 URL 为：`/static/template/案卷管理导入模板.xls`（不带 `/public` 前缀）。

### 5. 导入（Excel -> 数据库）
#### 5.1 交互流程
0. 前置校验：未选择左侧树节点（`projectId` 为空）时不允许导入，并提示：`请先选择档案项目`。
1. 点击“导入”弹出导入对话框。
2. 对话框内选择文件（仅允许 `xls/xlsx`），文件要求：模板格式一致。
3. 点击“开始导入”上传文件到后端。
4. 后端导入完成返回结果：成功/失败、成功条数、失败条数、失败原因（建议按行返回）。
5. 导入成功：
   1) 弹出成功提示。
   2) 自动刷新页面列表数据。

#### 5.2 导入与父级字段的关系（重要）
导入字段中：**全宗号、分类号、项目名称来自父级（档案项目）**。

规则：
1. 导入时允许 Excel 中这 3 列为空，后端以“当前父级档案项目”自动补齐。
2. 若 Excel 中填写了这 3 列：
   1) 可选择忽略 Excel 值，强制以父级为准（推荐，避免跨项目导入）。
   2) 或校验必须与父级一致，不一致则该行失败（可选策略）。
3. 导入必须明确关联到一个父级档案项目，前端需把父级 `projectId`（或等价字段）随导入请求传给后端。

补充：
1. 前端上传导入文件时必须携带 `projectId`。
2. 后端以该 `projectId` 作为导入数据归属的唯一依据。

#### 5.3 导入校验与错误提示
1. 文件为空/格式不正确：提示“未读取到有效数据/模板不正确”。
2. 字段校验失败：
   1) 返回失败行号 + 字段 + 原因。
   2) 前端以表格/列表展示失败明细（或提供下载失败明细）。
3. 导入应支持：
   1) 全量成功
   2) 部分成功（成功写入，失败行返回原因）

### 6. 导出（数据库 -> Excel）
#### 6.1 交互流程
0. 前置校验：未选择左侧树节点（`projectId` 为空）时不允许导出，并提示：`请先选择档案项目`。
1. 点击“导出”弹出导出对话框。
2. 用户确认导出范围：
   1) 默认：按当前页面筛选条件导出。
   2) 可选：仅导出勾选的数据。
3. 点击“开始导出”请求后端生成并返回文件流。
4. 浏览器下载导出的 Excel 文件。

请求参数要求：
1. 导出请求必须携带 `projectId`。
2. 若支持勾选导出：`ids[]` 与 `projectId` 同时传递，后端需校验这些数据均属于该 `projectId`。

#### 6.2 导出文件要求
1. 导出字段、顺序、表头名称与导入模板保持一致。
2. 文件名建议：`案卷管理导出_YYYYMMDDHHmmss.xls(x)`。

### 7. 字段清单（导入/导出一致）
字段顺序如下：
1. 全宗号
2. 档号
3. 分类号
4. 项目名称
5. 案卷顺序号
6. 套数
7. 案卷题名
8. 总页数
9. 总件数
10. 保管期限
11. 密级
12. 起始日期
13. 终止日期
14. 立卷单位
15. 组卷人
16. 归档日期
17. 检查人
18. 检查日期
19. 备注

字段规则补充：
1. **来自父级（导入可跳过）**：全宗号、分类号、项目名称。
2. 日期字段建议格式：`YYYY-MM-DD`。
3. 数值字段（案卷顺序号、套数、总页数、总件数）需为整数，非法则该行失败。

### 8. 后端需求（接口与处理约定）
#### 8.1 接口清单（示例，最终以实际后端路由规范为准）
1. **导入**：`POST /api/archives/archive-volume/import`
   1) 入参：`multipart/form-data`
   2) 参数：
      1) `file`: Excel 文件
      2) `projectId`: 父级档案项目 ID（必传）
   3) 出参（建议）：
      1) `success`: 是否成功
      2) `successCount`: 成功条数
      3) `failCount`: 失败条数
      4) `failRows`: 失败明细（行号、原因）

2. **导出**：`GET /api/archives/archive-volume/export`
   1) 入参：查询条件 + `projectId`（必传），或 `ids[]`（勾选导出）。
   2) 出参：Excel 文件流（设置正确的 `Content-Type` 与 `Content-Disposition`）。

3. **模板下载**：走静态资源，

#### 8.2 导入处理要求
1. 解析 Excel：以第一行表头匹配字段。
2. 写库策略：
   1) 支持部分成功（推荐）。
   2) 同一行数据写库需事务一致。
3. 父级字段：全宗号/分类号/项目名称统一以 `projectId` 对应的父级数据为准。

#### 8.3 导出处理要求
1. 导出数据来源：按 `projectId` + 查询条件过滤。
2. 生成 Excel：表头与模板一致，字段顺序一致。

### 9. 验收标准
1. 点击“模板下载”可正常下载 `案卷管理导入模板.xls`，文件可打开且表头正确。
2. 导入：
   1) 上传模板文件，后端能写入数据库。
   2) 导入成功后列表自动刷新，能看到新增的数据。
   3) 导入失败时给出明确错误信息（至少包含行号与原因）。
   4) Excel 中父级字段为空时仍可导入成功，且保存值来自父级档案项目。
3. 导出：
   1) 导出文件可下载并打开。
   2) 字段/表头/顺序与模板一致。
   3) 导出内容符合当前筛选条件,不分页,也就是导出所有符合筛选条件的