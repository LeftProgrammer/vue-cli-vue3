## 档案文件：Excel 模板下载 / 导入 / 导出 PRD（前后端）

### 1. 背景与目标
在“档案文件（文件管理）”页面提供 Excel 模板下载、批量导入、批量导出能力，用于对“案卷下文件”进行结构化数据维护。

目标：
1. **模板下载**：下载固定模板，用户按模板维护文件数据。
2. **导入**：上传模板文件后，后端解析并将文件数据写入数据库，导入完成刷新列表。
3. **导出**：按条件导出文件数据为 Excel（字段与模板一致），**不分页，导出所有符合条件的数据**。

### 2. 页面入口与前置条件
前端页面：
`E:\Project\XiongAn\vue\src\views\archives\archive_document\index.vue`

前置条件（必须）：
1. 导入/导出必须针对**指定案卷**进行。
2. 前端必须提供并传递 `volumeId`（案卷 ID）。
3. 未选中案卷（`volumeId` 为空）时：
   1) “导入/导出”按钮置灰不可点击（推荐）
   2) 或点击提示：`请先选择案卷`

### 3. 模板下载
模板文件路径：
`E:\Project\XiongAn\vue\public\static\template\文件管理导入模板.xls`

交互：
1. 点击“模板下载”直接下载模板文件。
2. 下载文件名：`文件管理导入模板.xls`

说明：
- `public/` 下资源构建后通常以站点根路径访问，例如：`/static/template/文件管理导入模板.xls`（不带 `/public` 前缀）

### 4. 导入（Excel -> 数据库）
#### 4.1 交互流程
1. 选择案卷（拿到 `volumeId`）
2. 点击“导入”弹出导入对话框
3. 选择文件（仅允许 `xls/xlsx`，模板格式一致）
4. 点击“开始导入”上传到后端
5. 后端返回导入结果：成功/失败、成功条数、失败条数、失败原因（建议按行返回）
6. 导入成功后：提示成功 + 刷新列表

#### 4.2 字段来源与归属（重要）
导入模板字段中，存在来自不同层级的数据（档案项目/案卷/文件）。导入时必须明确哪些字段**不以 Excel 为准**，而是由上级自动补齐或校验一致性。

需要先梳理并在后端实现以下规则（建议策略）：
1. **档案项目（project）字段**：来自案卷所属档案项目（通过 `volumeId -> projectId` 获取），导入时 Excel 可为空，后端自动补齐；若 Excel 有值，建议校验一致，否则该行失败。
2. **案卷（volume）字段**：来自上级案卷（通过 `volumeId` 获取），导入时 Excel 可为空，后端自动补齐；若 Excel 有值，建议校验一致，否则该行失败。
3. **文件（document）字段**：本次导入的主体数据，以 Excel 为准写库。

注意：
- 前端列表展示字段与导入模板字段 **不要求一致**，各自按业务需要展示。

#### 4.3 导入校验与错误返回
1. 文件为空/模板不正确：提示“未读取到有效数据/模板不正确”
2. 行数据校验失败：返回失败行号 + 字段 + 原因
3. 支持部分成功：成功行写库，失败行返回原因（推荐）
4. 写库事务：单行写库需事务一致，避免半写入

### 5. 导出（数据库 -> Excel）
#### 5.1 交互流程
1. 选择案卷（拿到 `volumeId`）
2. 点击“导出”弹出导出对话框（可仅确认，不强制复杂选项）
3. 点击“开始导出”调用后端导出接口
4. 浏览器下载导出的 Excel 文件

#### 5.2 导出规则（重要）
1. **导出不分页**：导出为“所有符合筛选条件的数据”（不受列表分页影响）
2. 导出必须限定在当前 `volumeId` 下
3. 导出字段、顺序、表头名称与模板一致

### 6. 模板字段（导入/导出一致，表头名称不变）
字段顺序如下（导入/导出必须一致）：
1. 全宗号
2. 档号
3. 分类号
4. 项目名称
5. 案卷顺序号
6. 套数
7. 卷内顺序号
8. 文件题名
9. 附件
10. 文件编号
11. 责任者
12. 日期
13. 页号
14. 立卷单位
15. 保管期限
16. 密级
17. 备注

### 7. 后端接口约定（示例，最终以实际规范为准）
1. 导入：`POST /api/archives/archive-document/import`
   - `multipart/form-data`
   - 参数：
     - `file`: Excel
     - `volumeId`: 案卷 ID（必传）
   - 返回（建议）：
     - `success`
     - `successCount`
     - `failCount`
     - `failRows`: [{ rowIndex, reason }]

2. 导出：`GET /api/archives/archive-document/export`
   - 参数：
     - `volumeId`（必传）
     - 其它筛选条件（来自前端筛选表单）
   - 返回：Excel 文件流（正确设置 `Content-Type`、`Content-Disposition`）

### 8. 验收标准
1. 模板下载可用：下载成功且表头正确
2. 导入：
   1) 未选中案卷不可导入，并提示/置灰
   2) 模板导入后后端写库成功，列表刷新可见
   3) 导入失败返回明确行号与原因
3. 导出：
   1) 未选中案卷不可导出，并提示/置灰
   2) 导出文件可打开
   3) 字段/表头/顺序与模板一致
   4) **不分页导出**：导出数量为所有符合筛选条件的数据