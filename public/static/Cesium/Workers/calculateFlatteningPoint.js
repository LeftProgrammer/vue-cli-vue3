define(["./Matrix4-3b2c0630","./ComponentDatatype-c4f4738c","./createTaskProcessorWorker","./defaultValue-81eec7ed","./Ellipsoid-119327cb","./Math-c2b1b304","./Plane-f0451b7c","./RuntimeError-8952249c","./WebGLConstants-508b9636"],(function(t,a,n,e,i,r,o,s,l){"use strict";function c(a,n){if(!a||!n||n.length<3)return!1;const e=n[0],i=n[1],r=n[2],s=t.Cartesian3.cross(t.Cartesian3.subtract(i,e,new t.Cartesian3),t.Cartesian3.subtract(r,e,new t.Cartesian3),new t.Cartesian3);t.Cartesian3.normalize(s,s),o.Plane.fromPointNormal(e,s);const l=e,c=t.Cartesian3.subtract(i,e,new t.Cartesian3);t.Cartesian3.normalize(c,c);const y=t.Cartesian3.cross(s,c,new t.Cartesian3);t.Cartesian3.normalize(y,y);const f=t.Cartesian3.dot(t.Cartesian3.subtract(a,l,new t.Cartesian3),c),u=t.Cartesian3.dot(t.Cartesian3.subtract(a,l,new t.Cartesian3),y),C=n.map((function(a){return{x:t.Cartesian3.dot(t.Cartesian3.subtract(a,l,new t.Cartesian3),c),y:t.Cartesian3.dot(t.Cartesian3.subtract(a,l,new t.Cartesian3),y)}}));let m=!1;for(let t=0,a=C.length-1;t<C.length;a=t++){const n=C[t],e=C[a];n.y>u!=e.y>u&&f<(e.x-n.x)*(u-n.y)/(e.y-n.y+1e-10)+n.x&&(m=!m)}return m}return n((function(n){const o=n.positionLen,s=n.pointLen,l=n.arrBuffer,y=n.sizeInBytes,f=n.flattenData,u=n.flattenHeight,C=n.primitiveId,m=n.transform,p=n.upAxis,x=new t.Matrix4;t.Matrix4.inverse(m,x);const h=new t.Cartesian3;t.Matrix4.multiplyByPoint(m,h,h);const M=i.Ellipsoid.WGS84.cartesianToCartographic(h),z=e.defined(n.quantization)?n.quantization:{};let d=!1;const g=n.draco,b=t.Matrix4.fromRotationTranslation(t.Matrix3.fromRotationX(r.CesiumMath.PI_OVER_TWO)),w=t.Matrix4.fromRotationTranslation(t.Matrix3.fromRotationX(-r.CesiumMath.PI_OVER_TWO));if(f.length>0){const n={};if(g){const a=[],e=new Uint16Array(y/2),i=new t.Cartesian3(-1/0,-1/0,-1/0),r=new t.Cartesian3(1/0,1/0,1/0),m=l,p=z.range/(1<<z.quantizationBits);for(let n=0;n<s;n++){const e=new t.Cartesian3(z.minValues[0]+m[n*o]*p,z.minValues[1]+m[n*o+1]*p,z.minValues[2]+m[n*o+2]*p);for(let t=0;t<f.length;t++){if(c(e,f[t])){e.z=u[t]-M.height,d=!0;break}}a.push(e),i.x=Math.max(i.x,e.x),i.y=Math.max(i.y,e.y),i.z=Math.max(i.z,e.z),r.x=Math.min(r.x,e.x),r.y=Math.min(r.y,e.y),r.z=Math.min(r.z,e.z)}let x=0;i.x-r.x>x&&(x=i.x-r.x),i.y-r.y>x&&(x=i.y-r.y),i.z-r.z>x&&(x=i.z-r.z);const h=1<<z.quantizationBits,g=h/x;for(let t=0;t<a.length;t++){const n=a[t],i=Math.floor((n.x-r.x)*g+.5),o=Math.floor((n.y-r.y)*g+.5),s=Math.floor((n.z-r.z)*g+.5);e[3*t]=i,e[3*t+1]=o,e[3*t+2]=s}n.typedArray=e,n.minValues=r,n.normConstant=x/h,n.range=x,n.isUpdate=d,n.primitiveId=C}else{const e=JSON.parse(JSON.stringify(f));if(!t.Matrix4.equals(x,t.Matrix4.IDENTITY))for(let a=0;a<e.length;a++)for(let n=0;n<e[a].length;n++)t.Matrix4.multiplyByPoint(x,e[a][n],e[a][n]);const r=a.ComponentDatatype.createArrayBufferView(a.ComponentDatatype.FLOAT,l.buffer,0,y/a.ComponentDatatype.getSizeInBytes(a.ComponentDatatype.FLOAT));for(let a=0;a<s;a++){const n=new t.Cartesian3(r[a*o],r[a*o+1],r[a*o+2]);1===p&&t.Matrix4.multiplyByPoint(b,n,n);for(let s=0;s<e.length;s++){if(c(n,e[s])){t.Matrix4.multiplyByPoint(m,n,n);const e=i.Ellipsoid.WGS84.cartesianToCartographic(n);e.height=u[s];const l=i.Ellipsoid.WGS84.cartographicToCartesian(e);t.Matrix4.multiplyByPoint(x,l,l),1===p&&t.Matrix4.multiplyByPoint(w,l,l),r[a*o]=l.x,r[a*o+1]=l.y,r[a*o+2]=l.z,d=!0;break}}}n.typedArray=new Uint8Array(r.buffer),n.isUpdate=d,n.primitiveId=C}return n}}))}));
