define(["exports","./Matrix2-115e2170","./Matrix4-3b2c0630","./Ellipsoid-119327cb","./defaultValue-81eec7ed","./EllipsoidTangentPlane-6354c9aa","./Math-c2b1b304","./PolylinePipeline-cfd2c1cf","./Transforms-51e2663f"],(function(e,a,t,n,r,i,s,o,l){"use strict";var c=Object.freeze({ROUNDED:0,MITERED:1,BEVELED:2});const C=[new t.Cartesian3,new t.Cartesian3],u=new t.Cartesian3,y=new t.Cartesian3,f=new t.Cartesian3,m=new t.Cartesian3,d=new t.Cartesian3,w=new t.Cartesian3,p=new t.Cartesian3,x=new t.Cartesian3,g=new t.Cartesian3,h=new t.Cartesian3,M=new t.Cartesian3,T={};let P=new n.Cartographic;function E(e,a,n,r){const i=e[0],s=e[1],o=t.Cartesian3.angleBetween(i,s),l=Math.ceil(o/r),c=new Array(l);let C;if(a===n){for(C=0;C<l;C++)c[C]=a;return c.push(n),c}const u=(n-a)/l;for(C=1;C<l;C++){const e=a+C*u;c[C]=e}return c[0]=a,c.push(n),c}const B=new t.Cartesian3,z=new t.Cartesian3;const b=new t.Cartesian3(-1,0,0);let A=new t.Matrix4;const D=new t.Matrix4;let S=new t.Matrix3;const I=t.Matrix3.IDENTITY.clone(),N=new t.Cartesian3,O=new t.Cartesian4,V=new t.Cartesian3;function F(e,n,s,o,c,C,u,y,f,m,d,w){let p=O;if(A=l.Transforms.eastNorthUpToFixedFrame(e,c,A),r.defined(m)||(m=new t.Cartesian3),0===m.z){let r=N;r=t.Matrix4.multiplyByPointAsVector(A,b,r),r=t.Cartesian3.normalize(r,r);const s=function(e,n,r,s){const o=new i.EllipsoidTangentPlane(r,s),l=o.projectPointOntoPlane(t.Cartesian3.add(r,e,B),B),c=o.projectPointOntoPlane(t.Cartesian3.add(r,n,z),z),C=a.Cartesian2.angleBetween(l,c);return c.x*l.y-c.y*l.x>=0?-C:C}(r,n,e,c);S=t.Matrix3.fromRotationZ(s)}else{let e=t.Cartesian3.subtract(f[1],f[0],new t.Cartesian3);e=t.Cartesian3.normalize(e,e);const a=new t.Cartesian3(0,0,-1);let n=new t.Cartesian3;t.Cartesian3.cross(a,e,n);t.Cartesian3.magnitude(n)<1e-5&&(n=a),t.Cartesian3.normalize(n,n);const r=t.Cartesian3.angleBetween(a,e),i=l.Quaternion.fromAxisAngle(n,r);S=t.Matrix3.fromQuaternion(i)}V.z=C,A=t.Matrix4.multiplyTransformation(A,t.Matrix4.fromRotationTranslation(S,V,D),A);const x=I;x[0]=u;for(let e=0;e<y;e++)for(let e=0;e<s.length;e+=3)p=t.Cartesian3.fromArray(s,e,p),p=t.Matrix3.multiplyByVector(x,p,p),p=t.Matrix4.multiplyByPoint(A,p,p),1===d&&(p=t.Matrix4.multiplyByPoint(w,p,p)),o.push(p.x,p.y,p.z);return o}const G=new t.Cartesian3;function _(e,a,n,r,i,s,o,l,c,C,u){for(let y=0;y<e.length;y+=3){r=F(t.Cartesian3.fromArray(e,y,G),a,n,r,i,s[y/3],o,1,l,c,C,u)}return r}function L(e,a,n){const i=e.length,s=new Array(3*i);let o=0;const l=a.x+a.width/2,c=a.y+a.height/2;if(r.defined(n)||(n=new t.Cartesian3),0===n.z)for(let a=0;a<i;a++)s[o++]=e[a].x-l,s[o++]=0,s[o++]=e[a].y-c;else for(let a=0;a<i;a++)s[o++]=e[a].x-l,s[o++]=e[a].y-c,s[o++]=0;return s}const Q=new l.Quaternion,R=new t.Cartesian3,v=new t.Matrix3;function j(e,a,n,r,i,o,C,u,y,f){const m=t.Cartesian3.angleBetween(t.Cartesian3.subtract(a,e,h),t.Cartesian3.subtract(n,e,M)),d=r===c.BEVELED?0:Math.ceil(m/s.CesiumMath.toRadians(5));let w,p,x;if(w=i?t.Matrix3.fromQuaternion(l.Quaternion.fromAxisAngle(t.Cartesian3.negate(e,h),m/(d+1),Q),v):t.Matrix3.fromQuaternion(l.Quaternion.fromAxisAngle(e,m/(d+1),Q),v),a=t.Cartesian3.clone(a,R),d>0){const n=f?2:1;for(let r=0;r<d;r++)a=t.Matrix3.multiplyByVector(w,a,a),p=t.Cartesian3.subtract(a,e,h),p=t.Cartesian3.normalize(p,p),i||(p=t.Cartesian3.negate(p,p)),x=o.scaleToGeodeticSurface(a,M),C=F(x,p,u,C,o,y,1,n,0,t.Matrix4.IDENTITY)}else p=t.Cartesian3.subtract(a,e,h),p=t.Cartesian3.normalize(p,p),i||(p=t.Cartesian3.negate(p,p)),x=o.scaleToGeodeticSurface(a,M),C=F(x,p,u,C,o,y,1,1,0,t.Matrix4.IDENTITY),n=t.Cartesian3.clone(n,R),p=t.Cartesian3.subtract(n,e,h),p=t.Cartesian3.normalize(p,p),i||(p=t.Cartesian3.negate(p,p)),x=o.scaleToGeodeticSurface(n,M),C=F(x,p,u,C,o,y,1,1,0,t.Matrix4.IDENTITY);return C}T.removeDuplicatesFromShape=function(e){const t=e.length,n=[];for(let r=t-1,i=0;i<t;r=i++){const t=e[r],s=e[i];a.Cartesian2.equals(t,s)||n.push(s)}return n},T.angleIsGreaterThanPi=function(e,a,n,r){const s=new i.EllipsoidTangentPlane(n,r),o=s.projectPointOntoPlane(t.Cartesian3.add(n,e,B),B),l=s.projectPointOntoPlane(t.Cartesian3.add(n,a,z),z);return l.x*o.y-l.y*o.x>=0};const q=new t.Cartesian3,Y=new t.Cartesian3;T.computePositions=function(e,a,n,i,l){const M=i._ellipsoid,B=e.slice(0),z=[],b=new t.Cartesian3,A=new t.Cartesian3;t.Cartesian3.clone(B[0],b),t.Cartesian3.clone(B[1],A);const D=new t.Matrix4;(void 0===i._rootTransform||i._rootTransform.equals(new t.Matrix4))&&(i._rootTransform=t.Matrix4.IDENTITY),t.Matrix4.inverse(i._rootTransform,D),t.Matrix4.multiplyByPoint(D,b,b),t.Matrix4.multiplyByPoint(D,A,A),z.push(b),z.push(A);const S=function(e,a){const t=new Array(e.length);for(let n=0;n<e.length;n++){const r=e[n];P=a.cartesianToCartographic(r,P),t[n]=P.height,e[n]=a.scaleToGeodeticSurface(r,r)}return t}(e,M),I=S[0].toFixed(2),N=S[1].toFixed(2),O=new t.Cartesian3(0,0,1*(1*I-1*N).toFixed(2)),V=i._granularity,G=i._cornerType,Q=l?function(e,a,n){const i=e.length,s=new Array(6*i);let o=0;const l=a.x+a.width/2,c=a.y+a.height/2;if(r.defined(n)||(n=new t.Cartesian3),0===n.z){let a=e[0];s[o++]=a.x-l,s[o++]=0,s[o++]=a.y-c;for(let t=1;t<i;t++){a=e[t];const n=a.x-l,r=a.y-c;s[o++]=n,s[o++]=0,s[o++]=r,s[o++]=n,s[o++]=0,s[o++]=r}a=e[0],s[o++]=a.x-l,s[o++]=0,s[o++]=a.y-c}else{let a=e[0];s[o++]=a.x-l,s[o++]=a.y-c,s[o++]=0;for(let t=1;t<i;t++){a=e[t];const n=a.x-l,r=a.y-c;s[o++]=n,s[o++]=r,s[o++]=0,s[o++]=n,s[o++]=r,s[o++]=0}a=e[0],s[o++]=a.x-l,s[o++]=a.y-c,s[o++]=0}return s}(a,n,O):L(a,n,O),R=l?L(a,n,O):void 0;let v=0;v=n.height/2;const U=n.width/2;let Z=e.length,k=[],H=l?[]:void 0,J=u,K=y,W=f,X=m,$=d,ee=w,ae=p,te=x,ne=g,re=e[0],ie=e[1];const se=i._isFromGLP;X=M.geodeticSurfaceNormal(re,X),J=t.Cartesian3.subtract(ie,re,J),J.equals(new t.Cartesian3(0,0,0))&&(J=new t.Cartesian3(0,-1,0)),J=t.Cartesian3.normalize(J,J),te=t.Cartesian3.cross(X,J,te),te=t.Cartesian3.normalize(te,te);let oe,le,ce=S[0],Ce=S[1];l&&(H=F(re,te,R,H,M,ce+v,1,1,z,O,se,D)),ne=t.Cartesian3.clone(re,ne),re=ie,K=t.Cartesian3.negate(J,K);for(let a=1;a<Z-1;a++){const n=l?2:1;ie=e[a+1],J=t.Cartesian3.subtract(ie,re,J),J=t.Cartesian3.normalize(J,J),W=t.Cartesian3.add(J,K,W),W=t.Cartesian3.normalize(W,W),X=M.geodeticSurfaceNormal(re,X);const r=t.Cartesian3.multiplyByScalar(X,t.Cartesian3.dot(J,X),q);t.Cartesian3.subtract(J,r,r),t.Cartesian3.normalize(r,r);const i=t.Cartesian3.multiplyByScalar(X,t.Cartesian3.dot(K,X),Y);t.Cartesian3.subtract(K,i,i),t.Cartesian3.normalize(i,i);if(!s.CesiumMath.equalsEpsilon(Math.abs(t.Cartesian3.dot(r,i)),1,s.CesiumMath.EPSILON7)){W=t.Cartesian3.cross(W,X,W),W=t.Cartesian3.cross(X,W,W),W=t.Cartesian3.normalize(W,W);const e=1/Math.max(.25,t.Cartesian3.magnitude(t.Cartesian3.cross(W,K,h))),a=T.angleIsGreaterThanPi(J,K,re,M);a?($=t.Cartesian3.add(re,t.Cartesian3.multiplyByScalar(W,e*U,W),$),ee=t.Cartesian3.add($,t.Cartesian3.multiplyByScalar(te,U,ee),ee),C[0]=t.Cartesian3.clone(ne,C[0]),C[1]=t.Cartesian3.clone(ee,C[1]),oe=E(C,ce+v,Ce+v,V),le=o.PolylinePipeline.generateArc({positions:C,granularity:V,ellipsoid:M}),k=_(le,te,Q,k,M,oe,1,z,O,se,D),te=t.Cartesian3.cross(X,J,te),te=t.Cartesian3.normalize(te,te),ae=t.Cartesian3.add($,t.Cartesian3.multiplyByScalar(te,U,ae),ae),G===c.ROUNDED||G===c.BEVELED?j($,ee,ae,G,a,M,k,Q,Ce+v,l):(W=t.Cartesian3.negate(W,W),k=F(re,W,Q,k,M,Ce+v,e,n,se,D)),ne=t.Cartesian3.clone(ae,ne)):($=t.Cartesian3.add(re,t.Cartesian3.multiplyByScalar(W,e*U,W),$),ee=t.Cartesian3.add($,t.Cartesian3.multiplyByScalar(te,-U,ee),ee),C[0]=t.Cartesian3.clone(ne,C[0]),C[1]=t.Cartesian3.clone(ee,C[1]),oe=E(C,ce+v,Ce+v,V),le=o.PolylinePipeline.generateArc({positions:C,granularity:V,ellipsoid:M}),k=_(le,te,Q,k,M,oe,1,z,O,se,D),te=t.Cartesian3.cross(X,J,te),te=t.Cartesian3.normalize(te,te),ae=t.Cartesian3.add($,t.Cartesian3.multiplyByScalar(te,-U,ae),ae),G===c.ROUNDED||G===c.BEVELED?j($,ee,ae,G,a,M,k,Q,Ce+v,l):k=F(re,W,Q,k,M,Ce+v,e,n,se,D),ne=t.Cartesian3.clone(ae,ne)),K=t.Cartesian3.negate(J,K)}else k=F(ne,te,Q,k,M,ce+v,1,1,se,D),ne=re;ce=Ce,Ce=S[a+1],re=ie}C[0]=t.Cartesian3.clone(ne,C[0]),C[1]=t.Cartesian3.clone(re,C[1]),oe=E(C,ce+v,Ce+v,V),le=o.PolylinePipeline.generateArc({positions:C,granularity:V,ellipsoid:M}),C[0].equals(C[1])&&3===le.length&&le.push(le[0],le[1],le[2]),k=_(le,te,Q,k,M,oe,1,z,O,se,D),l&&(H=F(re,te,R,H,M,Ce+v,1,1,z,O,se,D)),Z=k.length;const ue=l?Z+H.length:Z,ye=new Float64Array(ue);return ye.set(k),l&&ye.set(H,Z),ye},e.CornerType=c,e.PolylineVolumeGeometryLibrary=T}));
